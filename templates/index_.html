<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Circuit Analysis Results - Fixed</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            animation: fadeInUp 0.8s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            text-align: center;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% {
                left: -100%;
            }

            100% {
                left: 100%;
            }
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1.2rem;
            color: #666;
            font-weight: 400;
            position: relative;
            z-index: 1;
        }

        /* Upload Section */
        .upload-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }

        #upload-form {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
            justify-content: center;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            border-radius: 15px;
            padding: 15px 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.3);
        }

        .file-input-wrapper:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(79, 172, 254, 0.4);
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .file-input-label {
            color: white;
            font-weight: 600;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            user-select: none;
        }

        #page-num {
            padding: 15px 20px;
            border: 2px solid #e1e5e9;
            border-radius: 15px;
            font-size: 1rem;
            font-weight: 500;
            outline: none;
            transition: all 0.3s ease;
            background: white;
        }

        #page-num:focus {
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .submit-btn {
            padding: 15px 30px;
            border: none;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        #upload-status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 12px;
            font-weight: 500;
            text-align: center;
            transition: all 0.3s ease;
        }

        /* PDF Preview */
        .pdf-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            margin-bottom: 30px;
            overflow: hidden;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .pdf-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }

        .pdf-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .pdf-title {
            font-size: 1.4rem;
            font-weight: 700;
        }

        .pdf-info {
            font-size: 1rem;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pdf-controls {
            background: rgba(102, 126, 234, 0.1);
            padding: 20px 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .page-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .page-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .select-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .select-btn:hover:not(:disabled) {
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
        }

        .select-btn.active {
            background: linear-gradient(135deg, #dc3545, #fd7e14);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
        }

        .select-btn.active:hover {
            box-shadow: 0 8px 25px rgba(220, 53, 69, 0.4);
        }

        #pdf-page-input {
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 500;
            outline: none;
            transition: all 0.3s ease;
            background: white;
            width: 80px;
            text-align: center;
        }

        #pdf-page-input:focus {
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        /* Selection Controls */
        .selection-controls {
            background: rgba(40, 167, 69, 0.1);
            padding: 20px 30px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            display: none;
            animation: slideDown 0.3s ease-out;
        }

        .selection-controls.active {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .selection-row {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .selection-label {
            font-weight: 600;
            color: #155724;
            min-width: 120px;
        }

        #selected-pages {
            flex: 1;
            min-width: 300px;
            padding: 12px 15px;
            border: 2px solid rgba(40, 167, 69, 0.3);
            border-radius: 12px;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
        }

        #selected-pages:focus {
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
        }

        .clear-selection-btn {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.3);
        }

        .clear-selection-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(108, 117, 125, 0.4);
        }

        .pdf-display {
            cursor: pointer;
            padding: 30px;
            text-align: center;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            position: relative;
        }

        #pdf-canvas {
            max-width: 100%;
            height: auto;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            background: white;
        }

        .selection-indicator {
            position: absolute;
            top: 40px;
            right: 40px;
            background: rgba(40, 167, 69, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
            display: none;
            z-index: 10;
        }

        .selection-indicator.show {
            display: block;
            animation: fadeInScale 0.3s ease-out;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.8);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 8px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            gap: 5px;
        }

        .tab {
            flex: 1;
            padding: 15px 25px;
            border: none;
            background: transparent;
            border-radius: 15px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .tab:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* File Selection Status */
        .file-status {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #666;
        }

        .file-selected {
            color: #28a745;
            font-weight: 600;
        }

        /* Debug info */
        .debug-info {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            font-size: 0.9rem;
            color: #666;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            #upload-form {
                flex-direction: column;
                align-items: stretch;
            }

            .pdf-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .pdf-controls {
                flex-direction: column;
                gap: 15px;
            }

            .selection-row {
                flex-direction: column;
                align-items: stretch;
            }

            .selection-label {
                min-width: auto;
            }

            #selected-pages {
                min-width: auto;
            }
        }

                /* Tables */
        .table-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            margin-bottom: 30px;
            overflow: hidden;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .table-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }

        .table-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 1.4rem;
            font-weight: 700;
        }

        .download-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .download-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .table-wrapper {
            overflow-x: auto;
            max-height: 100vh;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th{
            padding: 15px 20px;
            text-align: left;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        td {
            text-align: left;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        th {
            background: rgb(182, 192, 235);
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        /* Images */
        .image-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            margin-bottom: 30px;
            overflow: hidden;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .image-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }

        .image-header {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
            padding: 20px 30px;
            font-size: 1.3rem;
            font-weight: 700;
        }

        .image-display {
            padding: 30px;
            text-align: center;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-display img {
            max-width: 100%;
            max-height: 500px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .image-display img:hover {
            transform: scale(1.02);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
        }

        /* Pagination */
        .pagination-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .pagination-header {
            background: linear-gradient(135deg, #764ba2, #667eea);
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .pagination-title {
            font-size: 1.4rem;
            font-weight: 700;
        }

        .pagination-info {
            font-size: 1rem;
            opacity: 0.9;
        }

        .pagination-controls {
            background: rgba(102, 126, 234, 0.1);
            padding: 20px 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .page-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .page-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .current-page {
            font-weight: 600;
            color: #333;
            background: white;
            padding: 12px 20px;
            border-radius: 12px;
            border: 2px solid rgba(102, 126, 234, 0.2);
        }

        .images-grid {
            padding: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }

        .images-grid img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .images-grid img:hover {
            transform: scale(1.05);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        /* Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .overlay-content {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .close-btn {
            position: absolute;
            top: 30px;
            right: 30px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1001;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .nav-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1001;
        }

        .nav-arrow:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-50%) scale(1.1);
        }

        .nav-arrow.prev {
            left: 30px;
        }

        .nav-arrow.next {
            right: 30px;
        }

        .overlay-image {
            max-width: 90%;
            max-height: 90%;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .overlay-info {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px 25px;
            border-radius: 15px;
            font-size: 1.1rem;
            font-weight: 500;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            #upload-form {
                flex-direction: column;
                align-items: stretch;
            }

            .tabs {
                flex-direction: column;
                gap: 5px;
            }

            .pagination-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .pagination-controls {
                flex-direction: column;
                gap: 15px;
            }

            .images-grid {
                grid-template-columns: 1fr;
                padding: 15px;
            }

            .nav-arrow {
                width: 45px;
                height: 45px;
                font-size: 1.5rem;
            }

            .nav-arrow.prev {
                left: 15px;
            }

            .nav-arrow.next {
                right: 15px;
            }

            .close-btn {
                top: 15px;
                right: 15px;
                width: 40px;
                height: 40px;
            }
        }

        /* Loading States */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .xml-upload-wrapper {
            margin-bottom: 20px;
            animation: fadeInUp 0.4s ease-out;
        }

        .xml-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border-radius: 18px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 20px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .xml-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.12);
        }
        .page-input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .page-label {
            font-weight: 600;
            color: #444;
        }

        .page-input-wrapper input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s ease;
            background: white;
        }

        .page-input-wrapper input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
        }

        /* Remove Button */
        .remove-xml-btn {
            background: linear-gradient(135deg, #dc3545, #fd7e14);
            border: none;
            padding: 12px 18px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
        }

        .remove-xml-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(220, 53, 69, 0.4);
        }
        .add-xml-btn {
            padding: 15px 30px;
            border: none;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
            border-radius: 15px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.3);
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .add-xml-btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 15px 35px rgba(79, 172, 254, 0.4);
        }

        .add-xml-btn:active {
            transform: scale(0.97);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }
        .row-highlight {
            background-color: #f8d7da !important; /* light red */
        }
        .row-highlight-success {
            background-color: #dcf8d7 !important; /* light green */
        }
        .row-right {
            background-color: #c8f7c5 !important; /* light green */
        }
        .row-wrong {
            background-color: #f7c5c5 !important; /* light red */
        }
        .btn-right {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 3px 6px;
            margin-right: 5px;
            cursor: pointer;
            border-radius: 4px;
        }
        .btn-wrong {
            background: #f44336;
            color: white;
            border: none;
            padding: 3px 6px;
            cursor: pointer;
            border-radius: 4px;
        }

    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>🔌 Circuit Analysis Results</h1>
            <p>Comprehensive analysis of your electrical circuit diagrams</p>
        </div>

        <div class="upload-section">
            <form id="upload-form" enctype="multipart/form-data">
                <div class="file-input-wrapper">
                    <input type="file" name="pdf_file" id="pdf-file" accept="application/pdf" required>
                    <label for="pdf-file" class="file-input-label">
                        📄 Choose PDF File
                    </label>
                </div>
                <!-- <div id="xml-files-container"></div>

                <button type="button" id="add-xml-btn" class="add-xml-btn">
                    ➕ Add XML File
                </button> -->

                <!-- <div class="file-input-wrapper">
                    <input type="file" name="xml_file" id="xml-file" accept="application/xml">
                    <label for="xml-file" class="file-input-label">
                        📄 Choose XML File
                    </label>
                </div> -->

                <input type="text" name="page_num" id="selected-pages" placeholder="Page Number" style="display: none;">

                <button type="submit" class="submit-btn" id="submit-btn">
                    📤 Upload & Analyze
                </button>
            </form>

            <div id="upload-status"></div>

            <!-- File selection status -->
            <div id="file-status" class="file-status">
                <div id="pdf-file-status">PDF: Not selected</div>
                <!-- <div id="xml-file-status">XML: Not selected</div> -->
            </div>

            <!-- Debug information -->
            <!-- <div class="debug-info" id="debug-info" style="display: none;">
                <strong>Debug Info:</strong>
                <div id="debug-content"></div>
            </div> -->
        </div>

        <div class="tabs">
            <button class="tab" id="pdf-preview-tab" onclick="showTab('pdf-preview')" style="display: none;">📄 PDF
                Preview</button>
            <button class="tab active" onclick="showTab('dataframes')">📊 Data Tables</button>
            <button class="tab" onclick="showTab('analysis-images')">🖼️ Analysis Images</button>
            <button class="tab" onclick="showTab('drawn-lines')">📝 Drawn Lines</button>
        </div>

        <!-- PDF Preview Tab -->
        <div id="pdf-preview" class="tab-content">
            <div class="pdf-container">
                <div class="pdf-header">
                    <div class="pdf-title">📄 PDF Preview</div>
                    <div class="pdf-info">
                        <span id="pdf-name">No file selected</span>
                        <span>•</span>
                        <span>Page <span id="current-pdf-page">1</span> of <span id="total-pdf-pages">1</span></span>
                    </div>
                </div>

                <div class="pdf-controls">
                    <button class="page-btn" id="pdf-prev-btn" onclick="changePdfPage(-1)">
                        ← Previous
                    </button>
                    <input type="number" id="pdf-page-input" min="1" value="1" onchange="goToPdfPage()">
                    <button class="page-btn" id="pdf-next-btn" onclick="changePdfPage(1)">
                        Next →
                    </button>
                    <button class="page-btn select-btn" id="select-toggle-btn" onclick="toggleSelection()">
                        ✓ Select Pages
                    </button>
                </div>

                <div class="selection-controls" id="selection-controls">
                    <div class="selection-row">
                        <!-- <label class="selection-label" for="selected-pages">Selected Pages:</label>
                        <input type="text" id="selected-pages"
                            placeholder="Enter page numbers separated by commas (e.g., 1, 3, 5-7, 10)" readonly> -->
                        <button class="clear-selection-btn" onclick="clearSelection()">
                            🗑️ Clear
                        </button>
                    </div>
                </div>

                <div class="pdf-display">
                    <canvas id="pdf-canvas"></canvas>
                    <div class="selection-indicator" id="selection-indicator">
                        ✓ Page Selected
                    </div>
                </div>
            </div>
        </div>

        <div id="dataframes" class="tab-content active">
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">Wire Analysis Data</div>
                    <button class="download-btn" onclick="downloadCSV('wire-data')">
                        📥 Download CSV
                    </button>
                </div>
                <div class="table-wrapper">
                    <table id="wire-table">
                        <thead id="wire-thead"></thead>
                        <tbody id="wire-tbody"></tbody>
                    </table>
                </div>
            </div>

            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">Connection Analysis Data</div>
                    <button class="download-btn" onclick="downloadCSV('connection-data')">
                        📥 Download CSV
                    </button>
                </div>
                <div class="table-wrapper">
                    <table id="connection-table">
                        <thead id="connection-thead"></thead>
                        <tbody id="connection-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Analysis Images Tab -->
        <div id="analysis-images" class="tab-content">
            <div class="image-container">
                <div class="image-header">🖼️ Combined Canvas</div>
                <div class="image-display">
                    <img id="combined-canvas" src="" alt="Combined Canvas" />
                </div>
            </div>

            <div class="image-container">
                <div class="image-header">📍 Junction Points</div>
                <div class="image-display">
                    <img id="junction-points" src="" alt="Junction Points" />
                </div>
            </div>

            <div class="image-container">
                <div class="image-header">📏 Line Canvas</div>
                <div class="image-display">
                    <img id="line-canvas" src="" alt="Line Canvas" />
                </div>
            </div>
        </div>

        <!-- Drawn Lines Tab -->
        <div id="drawn-lines" class="tab-content">
            <div class="pagination-container">
                <div class="pagination-header">
                    <div class="pagination-title">Drawn Lines Collection</div>
                    <div class="pagination-info">
                        Showing <span id="current-range">0-0</span> of <span id="total-images">0</span> images
                    </div>
                </div>
                <div class="pagination-controls">
                    <button class="page-btn" id="prev-btn" onclick="changePage(-1)">← Previous Page</button>
                    <span class="current-page">Page <span id="current-page">1</span> of <span id="total-pages">1</span></span>
                    <button class="page-btn" id="next-btn" onclick="changePage(1)">Next Page →</button>
                </div>

                <div class="pagination-controls">
                    <button class="page-btn" id="prev-image-btn" onclick="changeImagePage(-1)">← Prev 10</button>
                    <span id="image-page-info">Image Page 1 of 1</span>
                    <button class="page-btn" id="next-image-btn" onclick="changeImagePage(1)">Next 10 →</button>
                </div>
                <div class="images-grid" id="images-grid">
                    <!-- Images will be dynamically populated here -->
                </div>
            </div>
        </div>

        <!-- Overlay for image popup -->
        <div class="overlay" id="image-overlay">
            <div class="overlay-content">
                <button class="close-btn" onclick="closeOverlay()">&times;</button>
                <button class="nav-arrow prev" id="prev-overlay" onclick="navigateOverlay(-1)">&#8249;</button>
                <img class="overlay-image" id="overlay-image" src="" alt="">
                <button class="nav-arrow next" id="next-overlay" onclick="navigateOverlay(1)">&#8250;</button>
                <div class="overlay-info" id="overlay-info"></div>
            </div>
        </div>
    </div>
    <script>
        // PDF.js setup
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let pdfDoc = null;
        let currentPdfPage = 1;
        let totalPdfPages = 1;
        let isSelectionMode = false;
        const imagesPerPage = 20;
        let selectedPages = new Set();
        let sampleData = {};
        let currentPage = 1;
        let totalImages = 0;

        // Debug function
        // function debugLog(message, data = null) {
        //     console.log(`[DEBUG] ${message}`, data || '');
        //     const debugInfo = document.getElementById('debug-info');
        //     const debugContent = document.getElementById('debug-content');

        //     debugInfo.style.display = 'block';
        //     debugContent.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`;

        //     if (data) {
        //         debugContent.innerHTML += `<pre style="font-size: 0.8rem; margin: 5px 0;">${JSON.stringify(data, null, 2)}</pre>`;
        //     }
        // }

        // File input handlers with proper event binding
        document.addEventListener('DOMContentLoaded', function () {
            // debugLog('DOM Content Loaded');

            // PDF file input handler
            const pdfInput = document.getElementById('pdf-file');
            const pdfLabel = document.querySelector('label[for="pdf-file"]');
            const pdfStatus = document.getElementById('pdf-file-status');

            if (pdfInput && pdfLabel) {
                // debugLog('PDF input and label found');

                // Handle file selection
                pdfInput.addEventListener('change', function (e) {
                    // debugLog('PDF file input changed', { filesLength: e.target.files.length });

                    const file = e.target.files[0];
                    if (file) {
                        // debugLog('PDF file selected', { name: file.name, type: file.type, size: file.size });

                        if (file.type === 'application/pdf') {
                            pdfStatus.textContent = `PDF: ${file.name}`;
                            pdfStatus.classList.add('file-selected');

                            // Load PDF for preview
                            loadPDF(file);
                            document.getElementById('pdf-name').textContent = file.name;

                            // Show PDF preview tab
                            const pdfTab = document.getElementById('pdf-preview-tab');
                            if (pdfTab) {
                                pdfTab.style.display = 'flex';
                                // debugLog('PDF preview tab shown');
                            }

                            // Reset selection state
                            isSelectionMode = false;
                            selectedPages.clear();
                            updateSelectionUI();
                        } else {
                            pdfStatus.textContent = 'PDF: Invalid file type';
                            pdfStatus.classList.remove('file-selected');
                            // debugLog('Invalid PDF file type', { type: file.type });
                        }
                    } else {
                        pdfStatus.textContent = 'PDF: Not selected';
                        pdfStatus.classList.remove('file-selected');
                        // debugLog('No PDF file selected');
                    }
                });

                // Handle label click
                pdfLabel.addEventListener('click', function (e) {
                    e.preventDefault();
                    // debugLog('PDF label clicked');
                    pdfInput.click();
                });
            } else {
                // debugLog('PDF input or label not found', {
                    // pdfInput: !!pdfInput,
                    // pdfLabel: !!pdfLabel
                // });
            }
            const xmlFilesContainer = document.getElementById('xml-files-container');
            const addXmlBtn = document.getElementById('add-xml-btn');

            let xmlCounter = 0;

            addXmlBtn.addEventListener('click', () => {
                xmlCounter++;
                const wrapper = document.createElement('div');
                wrapper.className = "xml-upload-wrapper";
                wrapper.innerHTML = `
                    <div class="xml-card">
                        <div class="file-input-wrapper">
                            <input type="file" name="xml_file_${xmlCounter}" id="xml-file-${xmlCounter}" accept="application/xml">
                            <label for="xml-file-${xmlCounter}" class="file-input-label">
                                📄 Choose XML File
                            </label>
                            <span id="xml-status-${xmlCounter}" class="file-status">XML: Not selected</span>
                        </div>

                        <div class="page-input-wrapper">
                            <label for="xml-page-${xmlCounter}" class="page-label">📑 Page Number:</label>
                            <input type="text" name="xml_page_${xmlCounter}" id="xml-page-${xmlCounter}" placeholder="e.g. 5">
                        </div>

                        <button type="button" class="remove-xml-btn">❌ Remove</button>
                    </div>
                `;

                // Add file status update
                const xmlInput = wrapper.querySelector(`#xml-file-${xmlCounter}`);
                const xmlStatus = wrapper.querySelector(`#xml-status-${xmlCounter}`);

                xmlInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        xmlStatus.textContent = `XML: ${file.name}`;
                        xmlStatus.classList.add('file-selected');
                    } else {
                        xmlStatus.textContent = "XML: Not selected";
                        xmlStatus.classList.remove('file-selected');
                    }
                });

                // Add remove button logic
                wrapper.querySelector('.remove-xml-btn').addEventListener('click', () => {
                    wrapper.remove();
                });

                xmlFilesContainer.appendChild(wrapper);
            });

            // XML file input handler
            // const xmlInput = document.getElementById('xml-file');
            // const xmlLabel = document.querySelector('label[for="xml-file"]');
            // const xmlStatus = document.getElementById('xml-file-status');

            // if (xmlInput && xmlLabel) {
            //     // debugLog('XML input and label found');

            //     xmlInput.addEventListener('change', function (e) {
            //         // debugLog('XML file input changed', { filesLength: e.target.files.length });

            //         const file = e.target.files[0];
            //         if (file) {
            //             // // debugLog('XML file selected', { name: file.name, type: file.type, size: file.size });
            //             xmlStatus.textContent = `XML: ${file.name}`;
            //             xmlStatus.classList.add('file-selected');
            //         } else {
            //             xmlStatus.textContent = 'XML: Not selected';
            //             xmlStatus.classList.remove('file-selected');
            //             // debugLog('No XML file selected');
            //         }
            //     });

            //     xmlLabel.addEventListener('click', function (e) {
            //         e.preventDefault();
            //         // debugLog('XML label clicked');
            //         xmlInput.click();
            //     });
            // }
        });

        function loadPDF(file) {
            // debugLog('Loading PDF', { fileName: file.name });
            const fileReader = new FileReader();

            fileReader.onload = function () {
                // debugLog('PDF FileReader loaded');
                const typedarray = new Uint8Array(this.result);

                pdfjsLib.getDocument(typedarray).promise.then(function (pdf) {
                    // debugLog('PDF document loaded', { numPages: pdf.numPages });
                    pdfDoc = pdf;
                    totalPdfPages = pdf.numPages;
                    document.getElementById('total-pdf-pages').textContent = totalPdfPages;
                    document.getElementById('pdf-page-input').max = totalPdfPages;
                    document.getElementById('selected-pages').value = '1 - ' + totalPdfPages;
                    document.getElementById('selected-pages').style.removeProperty('display');
                    showTab('pdf-preview')
                    currentPdfPage = 1;
                    renderPdfPage(currentPdfPage);
                }).catch(function (error) {
                    // debugLog('Error loading PDF document', error);
                });
            };

            fileReader.onerror = function () {
                // debugLog('FileReader error', fileReader.error);
            };

            fileReader.readAsArrayBuffer(file);
        }

        function renderPdfPage(pageNumber) {
            if (!pdfDoc) {
                // debugLog('No PDF document to render');
                return;
            }

            // debugLog('Rendering PDF page', { pageNumber });

            pdfDoc.getPage(pageNumber).then(function (page) {
                const canvas = document.getElementById('pdf-canvas');
                const context = canvas.getContext('2d');

                // Calculate scale based on container width
                const container = document.querySelector('.pdf-display');
                const containerWidth = container.clientWidth - 60; // Account for padding
                const viewport = page.getViewport({ scale: 1 });
                const scale = Math.min(containerWidth / viewport.width, 1.5);
                const scaledViewport = page.getViewport({ scale: scale });

                canvas.height = scaledViewport.height;
                canvas.width = scaledViewport.width;

                const renderContext = {
                    canvasContext: context,
                    viewport: scaledViewport
                };

                page.render(renderContext).promise.then(function () {
                    // debugLog('PDF page rendered successfully');
                    document.getElementById('current-pdf-page').textContent = pageNumber;
                    document.getElementById('pdf-page-input').value = pageNumber;

                    // Update navigation buttons
                    document.getElementById('pdf-prev-btn').disabled = pageNumber <= 1;
                    document.getElementById('pdf-next-btn').disabled = pageNumber >= totalPdfPages;

                    // Update selection indicator
                    updateSelectionIndicator();
                    attachScrollListener();

                }).catch(function (error) {
                    // debugLog('Error rendering PDF page', error);
                });
            }).catch(function (error) {
                // debugLog('Error getting PDF page', error);
            });
        }

        function attachScrollListener() {
            const pdfCanvas = document.getElementById("pdf-canvas");
            const pdfDisplay = document.getElementById("pdf-display");

            [pdfCanvas, pdfDisplay].forEach(el => {
                if (!el || el.dataset.wheelBound) return; // avoid duplicate bindings
                el.addEventListener("wheel", handlePdfScroll, { passive: false });
                el.dataset.wheelBound = "true"; // mark as bound
            });
        }

        function handlePdfScroll(e) {
            if (e.deltaY > 0) {
                changePdfPage(1);
            } else {
                changePdfPage(-1);
            }
            e.preventDefault();
        }

        function changePdfPage(delta) {
            const newPage = currentPdfPage + delta;
            if (newPage >= 1 && newPage <= totalPdfPages) {
                currentPdfPage = newPage;
                renderPdfPage(currentPdfPage);
            }
        }

        function goToPdfPage() {
            const pageInput = document.getElementById('pdf-page-input');
            const page = parseInt(pageInput.value);
            if (page >= 1 && page <= totalPdfPages) {
                currentPdfPage = page;
                renderPdfPage(currentPdfPage);
            } else {
                pageInput.value = currentPdfPage;
            }
        }

        function toggleSelection() {
            isSelectionMode = !isSelectionMode;
            updateSelectionUI();

            if (isSelectionMode) {
                // Add click handler to canvas for page selection
                document.getElementById('pdf-canvas').addEventListener('click', handlePageSelection);
            } else {
                // Remove click handler
                document.getElementById('pdf-canvas').removeEventListener('click', handlePageSelection);
            }
        }

        function handlePageSelection() {
            if (!isSelectionMode) return;

            if (selectedPages.has(currentPdfPage)) {
                selectedPages.delete(currentPdfPage);
            } else {
                selectedPages.add(currentPdfPage);
            }

            updateSelectedPagesInput();
            updateSelectionIndicator();
        }

        function updateSelectionUI() {
            const selectBtn = document.getElementById('select-toggle-btn');
            const selectionControls = document.getElementById('selection-controls');

            if (isSelectionMode) {
                selectBtn.textContent = '✗ Exit Selection';
                selectBtn.classList.add('active');
                selectionControls.classList.add('active');
            } else {
                selectBtn.textContent = '✓ Select Pages';
                selectBtn.classList.remove('active');
                selectionControls.classList.remove('active');
            }
        }

        function updateSelectedPagesInput() {
            const input = document.getElementById('selected-pages');
            const sortedPages = Array.from(selectedPages).sort((a, b) => a - b);

            if (sortedPages.length === 0) {
                input.value = '';
                return;
            }

            // Convert to ranges for better readability
            const ranges = [];
            let start = sortedPages[0];
            let end = start;

            for (let i = 1; i <= sortedPages.length; i++) {
                if (i < sortedPages.length && sortedPages[i] === end + 1) {
                    end = sortedPages[i];
                } else {
                    if (start === end) {
                        ranges.push(start.toString());
                    } else if (end === start + 1) {
                        ranges.push(start.toString(), end.toString());
                    } else {
                        ranges.push(`${start}-${end}`);
                    }
                    if (i < sortedPages.length) {
                        start = sortedPages[i];
                        end = start;
                    }
                }
            }

            input.value = ranges.join(', ');
        }

        function updateSelectionIndicator() {
            const indicator = document.getElementById('selection-indicator');

            if (isSelectionMode && selectedPages.has(currentPdfPage)) {
                indicator.classList.add('show');
            } else {
                indicator.classList.remove('show');
            }
        }

        function clearSelection() {
            selectedPages.clear();
            updateSelectedPagesInput();
            updateSelectionIndicator();
        }

        // Tab switching function
        function showTab(tabName) {
            // debugLog('Switching to tab', { tabName });

            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab content
            const selectedTab = document.getElementById(tabName);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }

            // Add active class to clicked tab (find it by onclick content or other means)
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                if (tab.onclick && tab.onclick.toString().includes(tabName)) {
                    tab.classList.add('active');
                }
            });
        }

        // Form submission handler
        document.getElementById('upload-form').addEventListener('submit', function (event) {
            event.preventDefault();
            // debugLog('Form submitted');

            const pdfFileInput = document.getElementById('pdf-file');
            const pageNumInput = document.getElementById('selected-pages');
            const submitBtn = document.getElementById('submit-btn');
            const statusDiv = document.getElementById('upload-status');

            if (!pdfFileInput.files.length) {
                statusDiv.textContent = "❌ Please select a PDF file";
                statusDiv.className = "status-error";
                // debugLog('No PDF file selected');
                return;
            }

            if (!pageNumInput.value) {
                statusDiv.textContent = "❌ Please enter a page number";
                statusDiv.className = "status-error";
                // debugLog('No page number entered');
                return;
            }

            const formData = new FormData();
            formData.append('pdf_file', pdfFileInput.files[0]);

            formData.append('page_num', pageNumInput.value);
            formData.append('enable_network_colors', 'true');

            document.querySelectorAll('.xml-upload-wrapper').forEach((wrapper, idx) => {
                const fileInput = wrapper.querySelector('input[type="file"]');
                const pageInput = wrapper.querySelector('input[type="text"]');

                if (fileInput.files.length > 0 && pageInput.value) {
                    formData.append(`xml_files[${idx}]`, fileInput.files[0]);
                    formData.append(`xml_pages[${idx}]`, pageInput.value);
                }
            });

            // Disable submit button and show loading
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="loading"></div> Analyzing...';
            statusDiv.textContent = "⏳ Uploading and analyzing...";
            statusDiv.className = "status-info";

            // debugLog('Sending form data to /analyze');

            // Note: This will fail in the demo as there's no backend
            fetch('/analyze', {
                method: 'POST',
                body: formData
            })
                .then(res => {
                    // debugLog('Response received', { status: res.status, statusText: res.statusText });
                    return res.json();
                })
                .then(data => {
                    // debugLog('Analysis data received', data);
                    if (!data.success) {
                        throw new Error(data.error || "Analysis failed");
                    }

                    // Process the results here
                    statusDiv.textContent = "✅ Analysis complete!";
                    statusDiv.className = "status-success";
                    console.log('Analysis results:', data.result);
                    sampleData = {
                        wireData: data.result.wire_data || [],
                        connectionData: data.result.connection_data || [],
                        images: data.result.images || [],
                        // combinedCanvas: data.result.images || [],
                        // junctionPoints: data.result.images.junction_points || "",
                        // lineCanvas: data.result.images.line_canvas || "",
                        drawnLines: data.result.drawn_lines || []
                    };
                    initializePage();

                    // You would populate your tables and images here
                    // populateResults(data.result);

                })
                // .catch(err => {
                //     debugLog('Error during analysis', err);
                //     statusDiv.textContent = "❌ " + (err.message || "Network error - no backend available in demo");
                //     statusDiv.className = "status-error";
                // })
                .finally(() => {
                    // Re-enable submit button
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '📤 Upload & Analyze';
                });
        });

        function populateWireTable(data) {
            const thead = document.getElementById('wire-thead');
            const tbody = document.getElementById('wire-tbody');
            thead.innerHTML = "";
            tbody.innerHTML = "";

            if (data == undefined ||data.length === 0) return;

            // Create header
            const headerRow = document.createElement('tr');
            Object.keys(data[0]).forEach(key => {
                const th = document.createElement('th');
                th.textContent = key.replace('_', ' ').toUpperCase();
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);

            // Create rows
            data.forEach(row => {
                const tr = document.createElement('tr');
                Object.values(row).forEach(value => {
                    const td = document.createElement('td');
                    td.textContent = value;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        }

        // Populate connection data table
        // function populateConnectionTable(data) {
        //     const thead = document.getElementById('connection-thead');
        //     const tbody = document.getElementById('connection-tbody');
        //     thead.innerHTML = "";
        //     tbody.innerHTML = "";

        //     if (data.length === 0) return;

        //     // Create header
        //     const headerRow = document.createElement('tr');
        //     Object.keys(data[0]).forEach(key => {
        //         const th = document.createElement('th');
        //         th.textContent = key.replace('_', ' ').toUpperCase();
        //         headerRow.appendChild(th);
        //     });
        //     thead.appendChild(headerRow);

        //     // Create rows
        //     data.forEach(row => {
        //         const tr = document.createElement('tr');
        //         Object.values(row).forEach(value => {
        //             const td = document.createElement('td');
        //             td.textContent = value;
        //             tr.appendChild(td);
        //         });
        //         tbody.appendChild(tr);
        //     });
        // }

    function populateConnectionTable(data) {
        console.log('Populating connection table with data:', data);
        const columnOrder = [
            "source_component",
            "source_terminal",
            "dest_component",
            "dest_terminal",
            "wire_no",
            "page_number",
            "reason" // add reason column
        ];
        if (data == undefined || data.length === 0) return;


        data = data.map(row => {
            const reorderedRow = {};
            columnOrder.forEach(col => {
                if (row.hasOwnProperty(col)) {
                    reorderedRow[col] = row[col];
                }
            });
            // Add defaults
            reorderedRow.selected = "";
            reorderedRow.reason = reorderedRow.reason || ""; // default empty
            return reorderedRow;
        });

        const thead = document.getElementById('connection-thead');
        const tbody = document.getElementById('connection-tbody');
        thead.innerHTML = "";
        tbody.innerHTML = "";


        // Create header
        const headerRow = document.createElement('tr');
        Object.keys(data[0]).forEach(key => {
            if (key !== "selected") { // don't display selected as a column
                const th = document.createElement('th');
                th.textContent = key.replace('_', ' ').toUpperCase();
                headerRow.appendChild(th);
            }
        });
        headerRow.appendChild(document.createElement('th')); // for action buttons
        thead.appendChild(headerRow);

        // Create rows
        data.forEach((row, rowIndex) => {
            const tr = document.createElement('tr');
            Object.entries(row).forEach(([key, value]) => {
                if (key !== "selected") {
                    const td = document.createElement('td');

                    if (key === "reason") {
                        // input box for reason
                        const input = document.createElement('input');
                        input.type = "text";
                        input.value = value;
                        input.placeholder = "Enter reason";
                        input.addEventListener('input', (e) => {
                            data[rowIndex].reason = e.target.value;
                        });
                        // prevent row click when focusing or clicking inside input
                        input.addEventListener('click', (e) => e.stopPropagation());
                        td.appendChild(input);
                    } else {
                        td.textContent = value;
                    }

                    tr.appendChild(td);
                }
            });

            tr.addEventListener('click', () => {
                const wireNo = row["wire_no"];  // adjust if key is different
                const imageName = `Wire ${wireNo}`;
                const imgIndex = currentDisplayedImages.findIndex(img => img.name === imageName);

                if (imgIndex !== -1) {
                    openOverlay(imgIndex, currentDisplayedImages[imgIndex]);
                } else {
                    console.warn(`No image found for ${imageName} in currentDisplayedImages`);
                }
            });

            // Add buttons for "selected"
            const actionTd = document.createElement('td');

            const rightBtn = document.createElement('button');
            rightBtn.textContent = "Right";
            rightBtn.className = "btn-right";
            rightBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                tr.classList.remove('row-wrong');
                tr.classList.add('row-right');
                data[rowIndex].selected = "True";
            });

            const wrongBtn = document.createElement('button');
            wrongBtn.textContent = "Wrong";
            wrongBtn.className = "btn-wrong";
            wrongBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                tr.classList.remove('row-right');
                tr.classList.add('row-wrong');
                data[rowIndex].selected = "False";
            });

            actionTd.appendChild(rightBtn);
            actionTd.appendChild(wrongBtn);
            tr.appendChild(actionTd);

            tbody.appendChild(tr);
        });

        // store back modified data (so downloadCSV can use it)
        sampleData.connectionData = data;
    }
        function loadAnalysisImages() {
            const container = document.getElementById('analysis-images');
            container.innerHTML = ""; // clear old content

            if (!sampleData.images || sampleData.images.length === 0) return;

            sampleData.images.forEach((imgData) => {
                const pageNum = imgData.page;

                // Create wrapper
                const pageContainer = document.createElement('div');
                pageContainer.classList.add('page-container');

                // Combined Canvas
                pageContainer.innerHTML += `
                    <div class="image-container">
                        <div class="image-header">🖼️ Combined Canvas (Page ${pageNum})</div>
                        <div class="image-display">
                            <img src="${imgData.combined_canvas}" alt="Combined Canvas Page ${pageNum}" />
                        </div>
                    </div>
                `;

                // Junction Points
                pageContainer.innerHTML += `
                    <div class="image-container">
                        <div class="image-header">📍 Junction Points (Page ${pageNum})</div>
                        <div class="image-display">
                            <img src="${imgData.junction_points}" alt="Junction Points Page ${pageNum}" />
                        </div>
                    </div>
                `;

                // Line Canvas
                pageContainer.innerHTML += `
                    <div class="image-container">
                        <div class="image-header">📏 Line Canvas (Page ${pageNum})</div>
                        <div class="image-display">
                            <img src="${imgData.line_canvas}" alt="Line Canvas Page ${pageNum}" />
                        </div>
                    </div>
                `;

                container.appendChild(pageContainer);
            });
        }

        function groupImagesByPage(images) {
            const grouped = {};
            images.forEach(img => {
                if (!grouped[img.page]) {
                    grouped[img.page] = [];
                }
                grouped[img.page].push(img);
            });
            return grouped;
        }

        // Initialize pagination
        let groupedImages = {};
        let pageKeys = []; // list of PDF page numbers
        let currentPageIndex = 0; // index in pageKeys[]
        let currentImagePage = 1; // image pagination within a PDF page
        
        function initializePagination(images) {
            if (images==undefined) return;
            groupedImages = groupImagesByPage(images);
            pageKeys = Object.keys(groupedImages).sort((a, b) => a - b); 
            currentPageIndex = 0;
            currentImagePage = 1;

            document.getElementById('total-pages').textContent = pageKeys.length;
            displayImagesForPage(currentPageIndex, currentImagePage);
            updatePaginationControls();
        }

        function displayImagesForPage(pageIndex, imagePage) {
            const grid = document.getElementById('images-grid');
            grid.innerHTML = '';
            const currentPageNum = pageKeys[pageIndex];
            const images = groupedImages[currentPageNum];
            let imagesPerPage = images.length;
            const totalImagePages = Math.ceil(images.length / imagesPerPage);

            const startIndex = (imagePage - 1) * imagesPerPage;
            const endIndex = Math.min(startIndex + imagesPerPage, images.length);
            const pageImages = images.slice(startIndex, endIndex);

            // Update header info
            document.getElementById('current-page').textContent = pageIndex + 1;
            document.getElementById('total-images').textContent = images.length;
            document.getElementById('current-range').textContent = 
                `Page ${currentPageNum} — Showing ${startIndex + 1}-${endIndex}`;

            currentDisplayedImages = pageImages;

            pageImages.forEach((imgData, i) => {
                const imageDiv = document.createElement('div');
                imageDiv.className = 'grid-image';
                imageDiv.innerHTML = `
                    <img src="${imgData.image}" alt="${imgData.name}" />
                    <div class="grid-image-info">${imgData.name}</div>
                `;

                imageDiv.addEventListener('click', () => openOverlay(i, imgData));
                grid.appendChild(imageDiv);
            });

            // update extra controls for image pagination
            document.getElementById('image-page-info').textContent = 
                `Image Page ${imagePage} of ${totalImagePages}`;

            document.getElementById('prev-image-btn').disabled = imagePage === 1;
            document.getElementById('next-image-btn').disabled = imagePage === totalImagePages;
        }

        function displayImages(page, images) {
            const grid = document.getElementById('images-grid');
            grid.innerHTML = '';
            const startIndex = (page - 1) * imagesPerPage;
            const endIndex = Math.min(startIndex + imagesPerPage, images.length);
            
            // Store currently displayed images for overlay navigation
            currentDisplayedImages = images.slice(startIndex, endIndex);
           
            document.getElementById('current-range').textContent = `${startIndex + 1}-${endIndex}`;
            document.getElementById('current-page').textContent = page;
            
            for (let i = startIndex; i < endIndex; i++) {
                const imageDiv = document.createElement('div');
                imageDiv.className = 'grid-image';
                
                imageDiv.innerHTML = `
                    <img src="${images[i].image}" alt="${images[i].name}" />
                    <div class="grid-image-info">${images[i].name}</div>
                `;
                
                // Add click event to open overlay
                // imageDiv.addEventListener('click', () => openOverlay(i - startIndex, images[i]));
                const localIndex = i - startIndex;
                imageDiv.addEventListener('click', () => openOverlay(localIndex, currentDisplayedImages[localIndex]));

                grid.appendChild(imageDiv);
            }
        }

        function openOverlay(index, imageData) {
            currentOverlayIndex = index;
            const overlay = document.getElementById('image-overlay');
            const overlayImage = document.getElementById('overlay-image');
            const overlayInfo = document.getElementById('overlay-info');
            
            overlayImage.src = imageData.image;
            overlayImage.alt = imageData.name;
            overlayInfo.textContent = imageData.name;
            
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
            
            updateOverlayNavigation();
        }

        function closeOverlay() {
            const overlay = document.getElementById('image-overlay');
            overlay.classList.remove('active');
            document.body.style.overflow = ''; // Restore scrolling
        }

        function navigateOverlay(direction) {
            const newIndex = currentOverlayIndex + direction;
            
            if (newIndex >= 0 && newIndex < currentDisplayedImages.length) {
                currentOverlayIndex = newIndex;
                const imageData = currentDisplayedImages[currentOverlayIndex];
                
                const overlayImage = document.getElementById('overlay-image');
                const overlayInfo = document.getElementById('overlay-info');
                
                overlayImage.src = imageData.image;
                overlayImage.alt = imageData.name;
                overlayInfo.textContent = imageData.name;
                
                updateOverlayNavigation();
            }
        }

        function updateOverlayNavigation() {
            const prevBtn = document.getElementById('prev-overlay');
            const nextBtn = document.getElementById('next-overlay');
            
            prevBtn.disabled = currentOverlayIndex === 0;
            nextBtn.disabled = currentOverlayIndex === currentDisplayedImages.length - 1;
        }

        // Close overlay when clicking outside the image
        document.getElementById('image-overlay').addEventListener('click', function(e) {
            if (e.target === this) {
                closeOverlay();
            }
        });

        // Close overlay with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeOverlay();
            } else if (e.key === 'ArrowLeft') {
                navigateOverlay(-1);
            } else if (e.key === 'ArrowRight') {
                navigateOverlay(1);
            }
        });

        // Change page
        function changePage(direction) {
            const newIndex = currentPageIndex + direction;
            if (newIndex >= 0 && newIndex < pageKeys.length) {
                currentPageIndex = newIndex;
                currentImagePage = 1; // reset image page when switching PDF page
                displayImagesForPage(currentPageIndex, currentImagePage);
                updatePaginationControls();
            }
        }
        function changeImagePage(direction) {
            const currentPageNum = pageKeys[currentPageIndex];
            const images = groupedImages[currentPageNum];
            const totalImagePages = Math.ceil(images.length / imagesPerPage);

            const newImagePage = currentImagePage + direction;
            if (newImagePage >= 1 && newImagePage <= totalImagePages) {
                currentImagePage = newImagePage;
                displayImagesForPage(currentPageIndex, currentImagePage);
            }
        }

        function updatePaginationControls() {
            document.getElementById('prev-btn').disabled = currentPageIndex === 0;
            document.getElementById('next-btn').disabled = currentPageIndex === pageKeys.length - 1;
        }

        // Download CSV
        function downloadCSV(dataType) {
            let data, filename;
            
            if (dataType === 'wire-data') {
                data = sampleData.wireData;
                filename = 'wire_analysis.csv';
            } else if (dataType === 'connection-data') {
                data = sampleData.connectionData;
                filename = 'connection_analysis.csv';
            }

            if (data == undefined ||data.length === 0) return;

            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(header => row[header]).join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Initialize page when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializePage);

        function initializePage() {
            populateWireTable(sampleData.wireData);
            populateConnectionTable(sampleData.connectionData);
            loadAnalysisImages();
            initializePagination(sampleData.drawnLines);
        }

        // Handle window resize for responsive canvas
        window.addEventListener('resize', function () {
            if (pdfDoc && currentPdfPage) {
                renderPdfPage(currentPdfPage);
            }
        });

        // Initialize
        // debugLog('Script initialized');
    </script>
</body>

</html>