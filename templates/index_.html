{% extends "base.html" %}

{% block title %}Home - Electric Circuit Analyzer{% endblock %}

{% block content %}
    <div class="container">
        <div class="upload-section">
            <form id="upload-form" enctype="multipart/form-data">
                <div class="file-input-wrapper">
                    <input type="file" name="pdf_file" id="pdf-file" accept="application/pdf" required>
                    <label for="pdf-file" class="file-input-label">
                        üìÑ Choose PDF File
                    </label>
                </div>
                <!-- <div id="xml-files-container"></div>

                <button type="button" id="add-xml-btn" class="add-xml-btn">
                    ‚ûï Add XML File
                </button> -->

                <!-- <div class="file-input-wrapper">
                    <input type="file" name="xml_file" id="xml-file" accept="application/xml">
                    <label for="xml-file" class="file-input-label">
                        üìÑ Choose XML File
                    </label>
                </div> -->

                <input type="text" name="page_num" id="selected-pages" placeholder="Page Number" style="display: none;">

                <button type="submit" class="submit-btn" id="submit-btn">
                    üì§ Upload & Analyze
                </button>
            </form>

            <div id="upload-status"></div>

            <!-- File selection status -->
            <div id="file-status" class="file-status">
                <div id="pdf-file-status">PDF: Not selected</div>
                <!-- <div id="xml-file-status">XML: Not selected</div> -->
            </div>

            <!-- Debug information -->
            <!-- <div class="debug-info" id="debug-info" style="display: none;">
                <strong>Debug Info:</strong>
                <div id="debug-content"></div>
            </div> -->
        </div>

        <div class="tabs">
            <button class="tab" id="pdf-preview-tab" onclick="showTab('pdf-preview')" style="display: none;">üìÑ PDF
                Preview</button>
            <button class="tab active" onclick="showTab('dataframes')">üìä Data Tables</button>
            <button class="tab" onclick="showTab('analysis-images')">üñºÔ∏è Analysis Images</button>
            <button class="tab" onclick="showTab('drawn-lines')">üìù Drawn Lines</button>
        </div>

        <!-- PDF Preview Tab -->
        <div id="pdf-preview" class="tab-content">
            <div class="pdf-container">
                <div class="pdf-header">
                    <div class="pdf-title">üìÑ PDF Preview</div>
                    <div class="pdf-info">
                        <span id="pdf-name">No file selected</span>
                        <span>‚Ä¢</span>
                        <span>Page <span id="current-pdf-page">1</span> of <span id="total-pdf-pages">1</span></span>
                    </div>
                </div>

                <div class="pdf-controls">
                    <button class="page-btn" id="pdf-prev-btn" onclick="changePdfPage(-1)">
                        ‚Üê Previous
                    </button>
                    <input type="number" id="pdf-page-input" min="1" value="1" onchange="goToPdfPage()">
                    <button class="page-btn" id="pdf-next-btn" onclick="changePdfPage(1)">
                        Next ‚Üí
                    </button>
                    <button class="page-btn select-btn" id="select-toggle-btn" onclick="toggleSelection()">
                        ‚úì Select Pages
                    </button>
                </div>

                <div class="selection-controls" id="selection-controls">
                    <div class="selection-row">
                        <!-- <label class="selection-label" for="selected-pages">Selected Pages:</label>
                        <input type="text" id="selected-pages"
                            placeholder="Enter page numbers separated by commas (e.g., 1, 3, 5-7, 10)" readonly> -->
                        <button class="clear-selection-btn" onclick="clearSelection()">
                            üóëÔ∏è Clear
                        </button>
                    </div>
                </div>

                <div class="pdf-display">
                    <canvas id="pdf-canvas"></canvas>
                    <div class="selection-indicator" id="selection-indicator">
                        ‚úì Page Selected
                    </div>
                </div>
            </div>
        </div>

        <div id="dataframes" class="tab-content active">
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">Wire Analysis Data</div>
                    <button class="download-btn" onclick="downloadCSV('wire-data')">
                        üì• Download CSV
                    </button>
                </div>
                <div class="table-wrapper">
                    <table id="wire-table">
                        <thead id="wire-thead"></thead>
                        <tbody id="wire-tbody"></tbody>
                    </table>
                </div>
            </div>

            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">Connection Analysis Data</div>
                    <button class="download-btn" onclick="downloadCSV('connection-data')">
                        üì• Download CSV
                    </button>
                </div>
                <div class="table-wrapper">
                    <table id="connection-table">
                        <thead id="connection-thead"></thead>
                        <tbody id="connection-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Analysis Images Tab -->
        <div id="analysis-images" class="tab-content">
            <div class="image-container">
                <div class="image-header">üñºÔ∏è Combined Canvas</div>
                <div class="image-display">
                    <img id="combined-canvas" src="" alt="Combined Canvas" />
                </div>
            </div>

            <div class="image-container">
                <div class="image-header">üìç Junction Points</div>
                <div class="image-display">
                    <img id="junction-points" src="" alt="Junction Points" />
                </div>
            </div>

            <div class="image-container">
                <div class="image-header">üìè Line Canvas</div>
                <div class="image-display">
                    <img id="line-canvas" src="" alt="Line Canvas" />
                </div>
            </div>
        </div>

        <!-- Drawn Lines Tab -->
        <div id="drawn-lines" class="tab-content">
            <div class="pagination-container">
                <div class="pagination-header">
                    <div class="pagination-title">Drawn Lines Collection</div>
                    <div class="pagination-info">
                        Showing <span id="current-range">0-0</span> of <span id="total-images">0</span> images
                    </div>
                </div>
                <div class="pagination-controls">
                    <button class="page-btn" id="prev-btn" onclick="changePage(-1)">‚Üê Previous Page</button>
                    <span class="current-page">Page <span id="current-page">1</span> of <span id="total-pages">1</span></span>
                    <button class="page-btn" id="next-btn" onclick="changePage(1)">Next Page ‚Üí</button>
                </div>

                <div class="pagination-controls">
                    <button class="page-btn" id="prev-image-btn" onclick="changeImagePage(-1)">‚Üê Prev 10</button>
                    <span id="image-page-info">Image Page 1 of 1</span>
                    <button class="page-btn" id="next-image-btn" onclick="changeImagePage(1)">Next 10 ‚Üí</button>
                </div>
                <div class="images-grid" id="images-grid">
                    <!-- Images will be dynamically populated here -->
                </div>
            </div>
        </div>

        <!-- Overlay for image popup -->
        <div class="overlay" id="image-overlay">
            <div class="overlay-content">
                <button class="close-btn" onclick="closeOverlay()">&times;</button>
                <button class="nav-arrow prev" id="prev-overlay" onclick="navigateOverlay(-1)">&#8249;</button>
                <img class="overlay-image" id="overlay-image" src="" alt="">
                <button class="nav-arrow next" id="next-overlay" onclick="navigateOverlay(1)">&#8250;</button>
                <div class="overlay-info" id="overlay-info"></div>
            </div>
        </div>
    </div>
    <script>
        // PDF.js setup
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let pdfDoc = null;
        let currentPdfPage = 1;
        let totalPdfPages = 1;
        let isSelectionMode = false;
        const imagesPerPage = 20;
        let selectedPages = new Set();
        let sampleData = {};
        let currentPage = 1;
        let totalImages = 0;

        // Debug function
        // function debugLog(message, data = null) {
        //     console.log(`[DEBUG] ${message}`, data || '');
        //     const debugInfo = document.getElementById('debug-info');
        //     const debugContent = document.getElementById('debug-content');

        //     debugInfo.style.display = 'block';
        //     debugContent.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`;

        //     if (data) {
        //         debugContent.innerHTML += `<pre style="font-size: 0.8rem; margin: 5px 0;">${JSON.stringify(data, null, 2)}</pre>`;
        //     }
        // }

        // File input handlers with proper event binding
        document.addEventListener('DOMContentLoaded', function () {
            // debugLog('DOM Content Loaded');

            // PDF file input handler
            const pdfInput = document.getElementById('pdf-file');
            const pdfLabel = document.querySelector('label[for="pdf-file"]');
            const pdfStatus = document.getElementById('pdf-file-status');

            if (pdfInput && pdfLabel) {
                // debugLog('PDF input and label found');

                // Handle file selection
                pdfInput.addEventListener('change', function (e) {
                    // debugLog('PDF file input changed', { filesLength: e.target.files.length });

                    const file = e.target.files[0];
                    if (file) {
                        // debugLog('PDF file selected', { name: file.name, type: file.type, size: file.size });

                        if (file.type === 'application/pdf') {
                            pdfStatus.textContent = `PDF: ${file.name}`;
                            pdfStatus.classList.add('file-selected');

                            // Load PDF for preview
                            loadPDF(file);
                            document.getElementById('pdf-name').textContent = file.name;

                            // Show PDF preview tab
                            const pdfTab = document.getElementById('pdf-preview-tab');
                            if (pdfTab) {
                                pdfTab.style.display = 'flex';
                                // debugLog('PDF preview tab shown');
                            }

                            // Reset selection state
                            isSelectionMode = false;
                            selectedPages.clear();
                            updateSelectionUI();
                        } else {
                            pdfStatus.textContent = 'PDF: Invalid file type';
                            pdfStatus.classList.remove('file-selected');
                            // debugLog('Invalid PDF file type', { type: file.type });
                        }
                    } else {
                        pdfStatus.textContent = 'PDF: Not selected';
                        pdfStatus.classList.remove('file-selected');
                        // debugLog('No PDF file selected');
                    }
                });

                // Handle label click
                pdfLabel.addEventListener('click', function (e) {
                    e.preventDefault();
                    // debugLog('PDF label clicked');
                    pdfInput.click();
                });
            } else {
                // debugLog('PDF input or label not found', {
                    // pdfInput: !!pdfInput,
                    // pdfLabel: !!pdfLabel
                // });
            }
            const xmlFilesContainer = document.getElementById('xml-files-container');
            const addXmlBtn = document.getElementById('add-xml-btn');

            let xmlCounter = 0;

            addXmlBtn.addEventListener('click', () => {
                xmlCounter++;
                const wrapper = document.createElement('div');
                wrapper.className = "xml-upload-wrapper";
                wrapper.innerHTML = `
                    <div class="xml-card">
                        <div class="file-input-wrapper">
                            <input type="file" name="xml_file_${xmlCounter}" id="xml-file-${xmlCounter}" accept="application/xml">
                            <label for="xml-file-${xmlCounter}" class="file-input-label">
                                üìÑ Choose XML File
                            </label>
                            <span id="xml-status-${xmlCounter}" class="file-status">XML: Not selected</span>
                        </div>

                        <div class="page-input-wrapper">
                            <label for="xml-page-${xmlCounter}" class="page-label">üìë Page Number:</label>
                            <input type="text" name="xml_page_${xmlCounter}" id="xml-page-${xmlCounter}" placeholder="e.g. 5">
                        </div>

                        <button type="button" class="remove-xml-btn">‚ùå Remove</button>
                    </div>
                `;

                // Add file status update
                const xmlInput = wrapper.querySelector(`#xml-file-${xmlCounter}`);
                const xmlStatus = wrapper.querySelector(`#xml-status-${xmlCounter}`);

                xmlInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        xmlStatus.textContent = `XML: ${file.name}`;
                        xmlStatus.classList.add('file-selected');
                    } else {
                        xmlStatus.textContent = "XML: Not selected";
                        xmlStatus.classList.remove('file-selected');
                    }
                });

                // Add remove button logic
                wrapper.querySelector('.remove-xml-btn').addEventListener('click', () => {
                    wrapper.remove();
                });

                xmlFilesContainer.appendChild(wrapper);
            });

            // XML file input handler
            // const xmlInput = document.getElementById('xml-file');
            // const xmlLabel = document.querySelector('label[for="xml-file"]');
            // const xmlStatus = document.getElementById('xml-file-status');

            // if (xmlInput && xmlLabel) {
            //     // debugLog('XML input and label found');

            //     xmlInput.addEventListener('change', function (e) {
            //         // debugLog('XML file input changed', { filesLength: e.target.files.length });

            //         const file = e.target.files[0];
            //         if (file) {
            //             // // debugLog('XML file selected', { name: file.name, type: file.type, size: file.size });
            //             xmlStatus.textContent = `XML: ${file.name}`;
            //             xmlStatus.classList.add('file-selected');
            //         } else {
            //             xmlStatus.textContent = 'XML: Not selected';
            //             xmlStatus.classList.remove('file-selected');
            //             // debugLog('No XML file selected');
            //         }
            //     });

            //     xmlLabel.addEventListener('click', function (e) {
            //         e.preventDefault();
            //         // debugLog('XML label clicked');
            //         xmlInput.click();
            //     });
            // }
        });

        function loadPDF(file) {
            // debugLog('Loading PDF', { fileName: file.name });
            const fileReader = new FileReader();

            fileReader.onload = function () {
                // debugLog('PDF FileReader loaded');
                const typedarray = new Uint8Array(this.result);

                pdfjsLib.getDocument(typedarray).promise.then(function (pdf) {
                    // debugLog('PDF document loaded', { numPages: pdf.numPages });
                    pdfDoc = pdf;
                    totalPdfPages = pdf.numPages;
                    document.getElementById('total-pdf-pages').textContent = totalPdfPages;
                    document.getElementById('pdf-page-input').max = totalPdfPages;
                    document.getElementById('selected-pages').value = '1 - ' + totalPdfPages;
                    document.getElementById('selected-pages').style.removeProperty('display');
                    showTab('pdf-preview')
                    currentPdfPage = 1;
                    renderPdfPage(currentPdfPage);
                }).catch(function (error) {
                    // debugLog('Error loading PDF document', error);
                });
            };

            fileReader.onerror = function () {
                // debugLog('FileReader error', fileReader.error);
            };

            fileReader.readAsArrayBuffer(file);
        }

        function renderPdfPage(pageNumber) {
            if (!pdfDoc) {
                // debugLog('No PDF document to render');
                return;
            }

            // debugLog('Rendering PDF page', { pageNumber });

            pdfDoc.getPage(pageNumber).then(function (page) {
                const canvas = document.getElementById('pdf-canvas');
                const context = canvas.getContext('2d');

                // Calculate scale based on container width
                const container = document.querySelector('.pdf-display');
                const containerWidth = container.clientWidth - 60; // Account for padding
                const viewport = page.getViewport({ scale: 1 });
                const scale = Math.min(containerWidth / viewport.width, 1.5);
                const scaledViewport = page.getViewport({ scale: scale });

                canvas.height = scaledViewport.height;
                canvas.width = scaledViewport.width;

                const renderContext = {
                    canvasContext: context,
                    viewport: scaledViewport
                };

                page.render(renderContext).promise.then(function () {
                    // debugLog('PDF page rendered successfully');
                    document.getElementById('current-pdf-page').textContent = pageNumber;
                    document.getElementById('pdf-page-input').value = pageNumber;

                    // Update navigation buttons
                    document.getElementById('pdf-prev-btn').disabled = pageNumber <= 1;
                    document.getElementById('pdf-next-btn').disabled = pageNumber >= totalPdfPages;

                    // Update selection indicator
                    updateSelectionIndicator();
                    attachScrollListener();

                }).catch(function (error) {
                    // debugLog('Error rendering PDF page', error);
                });
            }).catch(function (error) {
                // debugLog('Error getting PDF page', error);
            });
        }

        function attachScrollListener() {
            const pdfCanvas = document.getElementById("pdf-canvas");
            const pdfDisplay = document.getElementById("pdf-display");

            [pdfCanvas, pdfDisplay].forEach(el => {
                if (!el || el.dataset.wheelBound) return; // avoid duplicate bindings
                el.addEventListener("wheel", handlePdfScroll, { passive: false });
                el.dataset.wheelBound = "true"; // mark as bound
            });
        }

        function handlePdfScroll(e) {
            if (e.deltaY > 0) {
                changePdfPage(1);
            } else {
                changePdfPage(-1);
            }
            e.preventDefault();
        }

        function changePdfPage(delta) {
            const newPage = currentPdfPage + delta;
            if (newPage >= 1 && newPage <= totalPdfPages) {
                currentPdfPage = newPage;
                renderPdfPage(currentPdfPage);
            }
        }

        function goToPdfPage() {
            const pageInput = document.getElementById('pdf-page-input');
            const page = parseInt(pageInput.value);
            if (page >= 1 && page <= totalPdfPages) {
                currentPdfPage = page;
                renderPdfPage(currentPdfPage);
            } else {
                pageInput.value = currentPdfPage;
            }
        }

        function toggleSelection() {
            isSelectionMode = !isSelectionMode;
            updateSelectionUI();

            if (isSelectionMode) {
                // Add click handler to canvas for page selection
                document.getElementById('pdf-canvas').addEventListener('click', handlePageSelection);
            } else {
                // Remove click handler
                document.getElementById('pdf-canvas').removeEventListener('click', handlePageSelection);
            }
        }

        function handlePageSelection() {
            if (!isSelectionMode) return;

            if (selectedPages.has(currentPdfPage)) {
                selectedPages.delete(currentPdfPage);
            } else {
                selectedPages.add(currentPdfPage);
            }

            updateSelectedPagesInput();
            updateSelectionIndicator();
        }

        function updateSelectionUI() {
            const selectBtn = document.getElementById('select-toggle-btn');
            const selectionControls = document.getElementById('selection-controls');

            if (isSelectionMode) {
                selectBtn.textContent = '‚úó Exit Selection';
                selectBtn.classList.add('active');
                selectionControls.classList.add('active');
            } else {
                selectBtn.textContent = '‚úì Select Pages';
                selectBtn.classList.remove('active');
                selectionControls.classList.remove('active');
            }
        }

        function updateSelectedPagesInput() {
            const input = document.getElementById('selected-pages');
            const sortedPages = Array.from(selectedPages).sort((a, b) => a - b);

            if (sortedPages.length === 0) {
                input.value = '';
                return;
            }

            // Convert to ranges for better readability
            const ranges = [];
            let start = sortedPages[0];
            let end = start;

            for (let i = 1; i <= sortedPages.length; i++) {
                if (i < sortedPages.length && sortedPages[i] === end + 1) {
                    end = sortedPages[i];
                } else {
                    if (start === end) {
                        ranges.push(start.toString());
                    } else if (end === start + 1) {
                        ranges.push(start.toString(), end.toString());
                    } else {
                        ranges.push(`${start}-${end}`);
                    }
                    if (i < sortedPages.length) {
                        start = sortedPages[i];
                        end = start;
                    }
                }
            }

            input.value = ranges.join(', ');
        }

        function updateSelectionIndicator() {
            const indicator = document.getElementById('selection-indicator');

            if (isSelectionMode && selectedPages.has(currentPdfPage)) {
                indicator.classList.add('show');
            } else {
                indicator.classList.remove('show');
            }
        }

        function clearSelection() {
            selectedPages.clear();
            updateSelectedPagesInput();
            updateSelectionIndicator();
        }

        // Tab switching function
        function showTab(tabName) {
            // debugLog('Switching to tab', { tabName });

            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab content
            const selectedTab = document.getElementById(tabName);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }

            // Add active class to clicked tab (find it by onclick content or other means)
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                if (tab.onclick && tab.onclick.toString().includes(tabName)) {
                    tab.classList.add('active');
                }
            });
        }

        // Form submission handler
        document.getElementById('upload-form').addEventListener('submit', function (event) {
            event.preventDefault();
            // debugLog('Form submitted');

            const pdfFileInput = document.getElementById('pdf-file');
            const pageNumInput = document.getElementById('selected-pages');
            const submitBtn = document.getElementById('submit-btn');
            const statusDiv = document.getElementById('upload-status');

            if (!pdfFileInput.files.length) {
                statusDiv.textContent = "‚ùå Please select a PDF file";
                statusDiv.className = "status-error";
                // debugLog('No PDF file selected');
                return;
            }

            if (!pageNumInput.value) {
                statusDiv.textContent = "‚ùå Please enter a page number";
                statusDiv.className = "status-error";
                // debugLog('No page number entered');
                return;
            }

            const formData = new FormData();
            formData.append('pdf_file', pdfFileInput.files[0]);

            formData.append('page_num', pageNumInput.value);
            formData.append('enable_network_colors', 'true');

            document.querySelectorAll('.xml-upload-wrapper').forEach((wrapper, idx) => {
                const fileInput = wrapper.querySelector('input[type="file"]');
                const pageInput = wrapper.querySelector('input[type="text"]');

                if (fileInput.files.length > 0 && pageInput.value) {
                    formData.append(`xml_files[${idx}]`, fileInput.files[0]);
                    formData.append(`xml_pages[${idx}]`, pageInput.value);
                }
            });

            // Disable submit button and show loading
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="loading"></div> Analyzing...';
            statusDiv.textContent = "‚è≥ Uploading and analyzing...";
            statusDiv.className = "status-info";

            // debugLog('Sending form data to /analyze');

            // Note: This will fail in the demo as there's no backend
            fetch('/analyze', {
                method: 'POST',
                body: formData
            })
                .then(res => {
                    // debugLog('Response received', { status: res.status, statusText: res.statusText });
                    return res.json();
                })
                .then(data => {
                    // debugLog('Analysis data received', data);
                    if (!data.success) {
                        throw new Error(data.error || "Analysis failed");
                    }

                    // Process the results here
                    statusDiv.textContent = "‚úÖ Analysis complete!";
                    statusDiv.className = "status-success";
                    console.log('Analysis results:', data.result);
                    sampleData = {
                        wireData: data.result.wire_data || [],
                        connectionData: data.result.connection_data || [],
                        images: data.result.images || [],
                        // combinedCanvas: data.result.images || [],
                        // junctionPoints: data.result.images.junction_points || "",
                        // lineCanvas: data.result.images.line_canvas || "",
                        drawnLines: data.result.drawn_lines || []
                    };
                    initializePage();

                    // You would populate your tables and images here
                    // populateResults(data.result);

                })
                // .catch(err => {
                //     debugLog('Error during analysis', err);
                //     statusDiv.textContent = "‚ùå " + (err.message || "Network error - no backend available in demo");
                //     statusDiv.className = "status-error";
                // })
                .finally(() => {
                    // Re-enable submit button
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'üì§ Upload & Analyze';
                });
        });

        function populateWireTable(data) {
            const thead = document.getElementById('wire-thead');
            const tbody = document.getElementById('wire-tbody');
            thead.innerHTML = "";
            tbody.innerHTML = "";

            if (data == undefined ||data.length === 0) return;

            // Create header
            const headerRow = document.createElement('tr');
            Object.keys(data[0]).forEach(key => {
                const th = document.createElement('th');
                th.textContent = key.replace('_', ' ').toUpperCase();
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);

            // Create rows
            data.forEach(row => {
                const tr = document.createElement('tr');
                Object.values(row).forEach(value => {
                    const td = document.createElement('td');
                    td.textContent = value;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        }

        // Populate connection data table
        // function populateConnectionTable(data) {
        //     const thead = document.getElementById('connection-thead');
        //     const tbody = document.getElementById('connection-tbody');
        //     thead.innerHTML = "";
        //     tbody.innerHTML = "";

        //     if (data.length === 0) return;

        //     // Create header
        //     const headerRow = document.createElement('tr');
        //     Object.keys(data[0]).forEach(key => {
        //         const th = document.createElement('th');
        //         th.textContent = key.replace('_', ' ').toUpperCase();
        //         headerRow.appendChild(th);
        //     });
        //     thead.appendChild(headerRow);

        //     // Create rows
        //     data.forEach(row => {
        //         const tr = document.createElement('tr');
        //         Object.values(row).forEach(value => {
        //             const td = document.createElement('td');
        //             td.textContent = value;
        //             tr.appendChild(td);
        //         });
        //         tbody.appendChild(tr);
        //     });
        // }

    function populateConnectionTable(data) {
        console.log('Populating connection table with data:', data);
        const columnOrder = [
            "source_component",
            "source_terminal",
            "dest_component",
            "dest_terminal",
            "wire_no",
            "page_number",
            "reason" // add reason column
        ];
        if (data == undefined || data.length === 0) return;


        data = data.map(row => {
            const reorderedRow = {};
            columnOrder.forEach(col => {
                if (row.hasOwnProperty(col)) {
                    reorderedRow[col] = row[col];
                }
            });
            // Add defaults
            reorderedRow.selected = "";
            reorderedRow.reason = reorderedRow.reason || ""; // default empty
            return reorderedRow;
        });

        const thead = document.getElementById('connection-thead');
        const tbody = document.getElementById('connection-tbody');
        thead.innerHTML = "";
        tbody.innerHTML = "";


        // Create header
        const headerRow = document.createElement('tr');
        Object.keys(data[0]).forEach(key => {
            if (key !== "selected") { // don't display selected as a column
                const th = document.createElement('th');
                th.textContent = key.replace('_', ' ').toUpperCase();
                headerRow.appendChild(th);
            }
        });
        headerRow.appendChild(document.createElement('th')); // for action buttons
        thead.appendChild(headerRow);

        // Create rows
        data.forEach((row, rowIndex) => {
            const tr = document.createElement('tr');
            Object.entries(row).forEach(([key, value]) => {
                if (key !== "selected") {
                    const td = document.createElement('td');

                    if (key === "reason") {
                        // input box for reason
                        const input = document.createElement('input');
                        input.type = "text";
                        input.value = value;
                        input.placeholder = "Enter reason";
                        input.addEventListener('input', (e) => {
                            data[rowIndex].reason = e.target.value;
                        });
                        // prevent row click when focusing or clicking inside input
                        input.addEventListener('click', (e) => e.stopPropagation());
                        td.appendChild(input);
                    } else {
                        td.textContent = value;
                    }

                    tr.appendChild(td);
                }
            });

            tr.addEventListener('click', () => {
                const wireNo = row["wire_no"];  // adjust if key is different
                const imageName = `Wire ${wireNo}`;
                const imgIndex = currentDisplayedImages.findIndex(img => img.name === imageName);

                if (imgIndex !== -1) {
                    openOverlay(imgIndex, currentDisplayedImages[imgIndex]);
                } else {
                    console.warn(`No image found for ${imageName} in currentDisplayedImages`);
                }
            });

            // Add buttons for "selected"
            const actionTd = document.createElement('td');

            const rightBtn = document.createElement('button');
            rightBtn.textContent = "Right";
            rightBtn.className = "btn-right";
            rightBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                tr.classList.remove('row-wrong');
                tr.classList.add('row-right');
                data[rowIndex].selected = "True";
            });

            const wrongBtn = document.createElement('button');
            wrongBtn.textContent = "Wrong";
            wrongBtn.className = "btn-wrong";
            wrongBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                tr.classList.remove('row-right');
                tr.classList.add('row-wrong');
                data[rowIndex].selected = "False";
            });

            actionTd.appendChild(rightBtn);
            actionTd.appendChild(wrongBtn);
            tr.appendChild(actionTd);

            tbody.appendChild(tr);
        });

        // store back modified data (so downloadCSV can use it)
        sampleData.connectionData = data;
    }
        function loadAnalysisImages() {
            const container = document.getElementById('analysis-images');
            container.innerHTML = ""; // clear old content

            if (!sampleData.images || sampleData.images.length === 0) return;

            sampleData.images.forEach((imgData) => {
                const pageNum = imgData.page;

                // Create wrapper
                const pageContainer = document.createElement('div');
                pageContainer.classList.add('page-container');

                // Combined Canvas
                pageContainer.innerHTML += `
                    <div class="image-container">
                        <div class="image-header">üñºÔ∏è Combined Canvas (Page ${pageNum})</div>
                        <div class="image-display">
                            <img src="${imgData.combined_canvas}" alt="Combined Canvas Page ${pageNum}" />
                        </div>
                    </div>
                `;

                // Junction Points
                pageContainer.innerHTML += `
                    <div class="image-container">
                        <div class="image-header">üìç Junction Points (Page ${pageNum})</div>
                        <div class="image-display">
                            <img src="${imgData.junction_points}" alt="Junction Points Page ${pageNum}" />
                        </div>
                    </div>
                `;

                // Line Canvas
                pageContainer.innerHTML += `
                    <div class="image-container">
                        <div class="image-header">üìè Line Canvas (Page ${pageNum})</div>
                        <div class="image-display">
                            <img src="${imgData.line_canvas}" alt="Line Canvas Page ${pageNum}" />
                        </div>
                    </div>
                `;

                container.appendChild(pageContainer);
            });
        }

        function groupImagesByPage(images) {
            const grouped = {};
            images.forEach(img => {
                if (!grouped[img.page]) {
                    grouped[img.page] = [];
                }
                grouped[img.page].push(img);
            });
            return grouped;
        }

        // Initialize pagination
        let groupedImages = {};
        let pageKeys = []; // list of PDF page numbers
        let currentPageIndex = 0; // index in pageKeys[]
        let currentImagePage = 1; // image pagination within a PDF page
        
        function initializePagination(images) {
            if (images==undefined) return;
            groupedImages = groupImagesByPage(images);
            pageKeys = Object.keys(groupedImages).sort((a, b) => a - b); 
            currentPageIndex = 0;
            currentImagePage = 1;

            document.getElementById('total-pages').textContent = pageKeys.length;
            displayImagesForPage(currentPageIndex, currentImagePage);
            updatePaginationControls();
        }

        function displayImagesForPage(pageIndex, imagePage) {
            const grid = document.getElementById('images-grid');
            grid.innerHTML = '';
            const currentPageNum = pageKeys[pageIndex];
            const images = groupedImages[currentPageNum];
            let imagesPerPage = images.length;
            const totalImagePages = Math.ceil(images.length / imagesPerPage);

            const startIndex = (imagePage - 1) * imagesPerPage;
            const endIndex = Math.min(startIndex + imagesPerPage, images.length);
            const pageImages = images.slice(startIndex, endIndex);

            // Update header info
            document.getElementById('current-page').textContent = pageIndex + 1;
            document.getElementById('total-images').textContent = images.length;
            document.getElementById('current-range').textContent = 
                `Page ${currentPageNum} ‚Äî Showing ${startIndex + 1}-${endIndex}`;

            currentDisplayedImages = pageImages;

            pageImages.forEach((imgData, i) => {
                const imageDiv = document.createElement('div');
                imageDiv.className = 'grid-image';
                imageDiv.innerHTML = `
                    <img src="${imgData.image}" alt="${imgData.name}" />
                    <div class="grid-image-info">${imgData.name}</div>
                `;

                imageDiv.addEventListener('click', () => openOverlay(i, imgData));
                grid.appendChild(imageDiv);
            });

            // update extra controls for image pagination
            document.getElementById('image-page-info').textContent = 
                `Image Page ${imagePage} of ${totalImagePages}`;

            document.getElementById('prev-image-btn').disabled = imagePage === 1;
            document.getElementById('next-image-btn').disabled = imagePage === totalImagePages;
        }

        function displayImages(page, images) {
            const grid = document.getElementById('images-grid');
            grid.innerHTML = '';
            const startIndex = (page - 1) * imagesPerPage;
            const endIndex = Math.min(startIndex + imagesPerPage, images.length);
            
            // Store currently displayed images for overlay navigation
            currentDisplayedImages = images.slice(startIndex, endIndex);
           
            document.getElementById('current-range').textContent = `${startIndex + 1}-${endIndex}`;
            document.getElementById('current-page').textContent = page;
            
            for (let i = startIndex; i < endIndex; i++) {
                const imageDiv = document.createElement('div');
                imageDiv.className = 'grid-image';
                
                imageDiv.innerHTML = `
                    <img src="${images[i].image}" alt="${images[i].name}" />
                    <div class="grid-image-info">${images[i].name}</div>
                `;
                
                // Add click event to open overlay
                // imageDiv.addEventListener('click', () => openOverlay(i - startIndex, images[i]));
                const localIndex = i - startIndex;
                imageDiv.addEventListener('click', () => openOverlay(localIndex, currentDisplayedImages[localIndex]));

                grid.appendChild(imageDiv);
            }
        }

        function openOverlay(index, imageData) {
            currentOverlayIndex = index;
            const overlay = document.getElementById('image-overlay');
            const overlayImage = document.getElementById('overlay-image');
            const overlayInfo = document.getElementById('overlay-info');
            
            overlayImage.src = imageData.image;
            overlayImage.alt = imageData.name;
            overlayInfo.textContent = imageData.name;
            
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
            
            updateOverlayNavigation();
        }

        function closeOverlay() {
            const overlay = document.getElementById('image-overlay');
            overlay.classList.remove('active');
            document.body.style.overflow = ''; // Restore scrolling
        }

        function navigateOverlay(direction) {
            const newIndex = currentOverlayIndex + direction;
            
            if (newIndex >= 0 && newIndex < currentDisplayedImages.length) {
                currentOverlayIndex = newIndex;
                const imageData = currentDisplayedImages[currentOverlayIndex];
                
                const overlayImage = document.getElementById('overlay-image');
                const overlayInfo = document.getElementById('overlay-info');
                
                overlayImage.src = imageData.image;
                overlayImage.alt = imageData.name;
                overlayInfo.textContent = imageData.name;
                
                updateOverlayNavigation();
            }
        }

        function updateOverlayNavigation() {
            const prevBtn = document.getElementById('prev-overlay');
            const nextBtn = document.getElementById('next-overlay');
            
            prevBtn.disabled = currentOverlayIndex === 0;
            nextBtn.disabled = currentOverlayIndex === currentDisplayedImages.length - 1;
        }

        // Close overlay when clicking outside the image
        document.getElementById('image-overlay').addEventListener('click', function(e) {
            if (e.target === this) {
                closeOverlay();
            }
        });

        // Close overlay with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeOverlay();
            } else if (e.key === 'ArrowLeft') {
                navigateOverlay(-1);
            } else if (e.key === 'ArrowRight') {
                navigateOverlay(1);
            }
        });

        // Change page
        function changePage(direction) {
            const newIndex = currentPageIndex + direction;
            if (newIndex >= 0 && newIndex < pageKeys.length) {
                currentPageIndex = newIndex;
                currentImagePage = 1; // reset image page when switching PDF page
                displayImagesForPage(currentPageIndex, currentImagePage);
                updatePaginationControls();
            }
        }
        function changeImagePage(direction) {
            const currentPageNum = pageKeys[currentPageIndex];
            const images = groupedImages[currentPageNum];
            const totalImagePages = Math.ceil(images.length / imagesPerPage);

            const newImagePage = currentImagePage + direction;
            if (newImagePage >= 1 && newImagePage <= totalImagePages) {
                currentImagePage = newImagePage;
                displayImagesForPage(currentPageIndex, currentImagePage);
            }
        }

        function updatePaginationControls() {
            document.getElementById('prev-btn').disabled = currentPageIndex === 0;
            document.getElementById('next-btn').disabled = currentPageIndex === pageKeys.length - 1;
        }

        // Download CSV
        function downloadCSV(dataType) {
            let data, filename;
            
            if (dataType === 'wire-data') {
                data = sampleData.wireData;
                filename = 'wire_analysis.csv';
            } else if (dataType === 'connection-data') {
                data = sampleData.connectionData;
                filename = 'connection_analysis.csv';
            }

            if (data == undefined ||data.length === 0) return;

            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(header => row[header]).join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Initialize page when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializePage);

        function initializePage() {
            populateWireTable(sampleData.wireData);
            populateConnectionTable(sampleData.connectionData);
            loadAnalysisImages();
            initializePagination(sampleData.drawnLines);
        }

        // Handle window resize for responsive canvas
        window.addEventListener('resize', function () {
            if (pdfDoc && currentPdfPage) {
                renderPdfPage(currentPdfPage);
            }
        });

        // Initialize
        // debugLog('Script initialized');
    </script>
{% endblock %}